name: Visual Regression Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  visual-regression:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
        
    - name: Install wasm-pack
      run: |
        curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build WASM module
      run: npm run build:wasm
      
    - name: Start data server
      run: |
        npm run dev:server &
        sleep 10  # Wait for server to start
        
    - name: Start React dev server
      run: |
        cd web
        npm run dev &
        sleep 10  # Wait for React to start
        
    - name: Copy package-lock.json to web directory
      run: cp package-lock.json web/
        
    - name: Run Cypress visual regression tests
      uses: cypress-io/github-action@v6
      with:
        working-directory: web
        spec: cypress/e2e/visual-regression-*.cy.ts
        config-file: cypress.config.ci.cjs
        browser: chrome
        wait-on: 'http://localhost:3000'
        wait-on-timeout: 120
        install: false  # Skip install since we already ran npm ci at root
      env:
        CYPRESS_CI: true
        
    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cypress-screenshots
        path: web/cypress/screenshots
        retention-days: 7
        
    - name: Upload visual regression diff images
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: visual-regression-diffs
        path: |
          web/cypress/snapshots/diff
          web/cypress/snapshots/actual
        retention-days: 7
        if-no-files-found: ignore
        
    - name: Upload visual regression baselines
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: visual-regression-baselines
        path: web/cypress/fixtures/visual-baselines
        retention-days: 7
        if-no-files-found: ignore
        
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Check if there are any diff images
          const diffPath = 'web/cypress/snapshots/diff';
          const screenshotsPath = 'web/cypress/screenshots';
          let comment = '## ðŸ“¸ Visual Regression Test Results\n\n';
          
          // Check for failed tests from screenshots
          let failedTests = [];
          if (fs.existsSync(screenshotsPath)) {
            const screenshots = fs.readdirSync(screenshotsPath, { recursive: true });
            failedTests = screenshots.filter(file => 
              file.toString().includes('(failed)'));
          }
          
          if (failedTests.length > 0) {
            comment += `âš ï¸ **${failedTests.length} visual regression tests failed**\n\n`;
            comment += 'Visual differences exceeded the 5% threshold.\n\n';
            comment += '### Failed tests:\n';
            failedTests.forEach(test => {
              const testName = test.toString().replace('(failed).png', '').replace(/.*\//, '');
              comment += `- ${testName}\n`;
            });
            comment += '\nðŸ“¦ **Artifacts uploaded:**\n';
            comment += '- `cypress-screenshots`: All test screenshots\n';
            comment += '- `visual-regression-diffs`: Difference images (if generated)\n';
            comment += '- `visual-regression-baselines`: Current baseline images\n';
            comment += '\nðŸ’¡ **To update baselines:** Download the screenshots artifact and update the baseline images in `web/cypress/fixtures/visual-baselines/`\n';
          } else if (fs.existsSync(diffPath) && fs.readdirSync(diffPath).length > 0) {
            const diffs = fs.readdirSync(diffPath);
            comment += `âš ï¸ **${diffs.length} visual differences detected**\n\n`;
            comment += 'Please review the diff images in the artifacts.\n\n';
            comment += '### Affected screenshots:\n';
            diffs.forEach(diff => {
              comment += `- ${diff}\n`;
            });
          } else {
            comment += 'âœ… **All visual regression tests passed!**\n\n';
            comment += 'No visual differences detected.\n';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });